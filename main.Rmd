---
title: "The Affordable Housing Crunch"
author: "Ethan Jantz & Alex Kwan"
date: "4/17/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup,  message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(here)
library(tidycensus)
library(tigris)
library(tidyverse)


# Ingests and cleans the HUD data
# Creates the object hud_data_raw in env
# Source: https://www.huduser.gov/portal/datasets/fmr.html
# Methodology: https://www.huduser.gov/portal/sites/default/files/pdf/fmr-overview.pdf
# NOTE: some years have more ZIP codes than others in this data
# TODO: Find out which ZIPs are included in all data
source(here("ingest_hud_data.R"))

# Zillow Observed Rent Index (ZORI) data
# Source: https://www.zillow.com/research/data/
# NOTE: Not every ZIP code in Chicago is included in this data, we'll probably have to 
# identify some set of ZIP codes in both datasets and use those
# as a case study
zori_raw <- read_csv(here("Data", "ZORI_AllHomesPlusMultifamily_SSA_ZIP.csv")) %>%
  filter(RegionName %in% hud_data_raw$ZIP) # 92 ZIP Codes
```

# Background

Why is affordable housing important? Housing as a social determinant of health. Affordable housing being related to better health outcomes for tenants. Evictions being related to poor health outcomes. Rental affordability as the average rent in relation to what HUD determines to be the Fair Market Rent, and what that means about affordability. Fair Market Rent, or FMR, is determined by a combination of a Census survey of rents paid by recent movers, rent inflation adjustment and forecasted expected growth.

# Research Questions

- Is the U.S. Department of Housing and Urban Developmentâ€™s Fair Market Rent calculations representative of actual rents in an area?
- If there is a difference between actual rents and Fair Market Rents as determined by HUD, what data can we use to explain those differences?

# Data Plan

Discrepancies in data availability. Some ZIP codes are missing values for some years in the ZORI data, some HUD data is missing data for ZIP Codes across years.

Time permitting add census demographic data from the ACS.

# Analysis Plan

Zillow's ZORI data provides average rents across all units, **regardless of the number of bedrooms**. We need some method to compare ZORI values with the values provided by HUD. This could take the form of finding the best fitting bedroom size or collapsing the HUD bedroom values into one average value. We can try both and see what works best.

```{r message=FALSE}

### The final dataset should have no missing values for a ZIP code in any year. That means that the ZIP codes should have values for all years in the the hud and zori datasets.

### --------------
### hud data
###

hud_data <- hud_data_raw %>%
  # Create a variable to map to the ZORI values
  mutate(br_avg = (br_0 + br_1 + br_2 + br_3 + br_4) / 5) %>% 
  select(!c(br_0:br_4)) %>%
  # saw some duplicates on the year-zip level
  distinct()

### ------------
### zori data
###

zori_staging <- zori_raw %>%
  filter(RegionName %in% hud_data_raw$ZIP) %>% # 92 ZIP Codes
  pivot_longer(cols = "2014-01":"2017-10",
               names_to = c("year","month"),
               names_sep = "-",
               values_to = "rent",
               names_transform = list(year = as.double)) %>%
  select("RegionName","year","month","rent") 

# quite a bit of missing data, ignoring issue for now
# zori_staging %>%
#   group_by(RegionName, year) %>%
#   summarize(rent_missing_prop = sum(is.na(rent))/12)

zori <- zori_staging %>%
  group_by(RegionName, year) %>%
  summarize(rent_avg = mean(rent, na.rm = TRUE))

### -----------
### combined
###

data <- zori %>%
  left_join(hud_data, by = c("RegionName" = "ZIP", "year" = "year")) %>%
  rename(hud_avg = br_avg, zori_avg = rent_avg)

```

# Plots

Once we have both our data fully cleaned we'll want to do some basic visualizations of the data. I see this taking the form of a distribution plot across ZIP codes by year, a series of maps by year, and trend lines of ZORI values and FMR values.

```{r message=FALSE}
### -----------
### Trend plot
###
# Shows the parallel trend lines between observed rents and HUD's FMR values 
# average across ZIP codes observed in data. We need to explain what this is,
# and why it's the case. It's because FMR is derived from actual rents, and
# the process for determining FMR excludes the newest housing stock (buildings
# constructed in the past 2 years). 
data %>%
  group_by(year) %>%
  summarize(ZORI = mean(zori_avg),
         HUD = mean(hud_avg)) %>%
  pivot_longer(cols = c(ZORI:HUD),
               names_to = "index",
               values_to = "rent") %>%
  ggplot(aes(x = year, y = rent, color = index)) +
  geom_line(size = 2, lineend = "round") +
  labs(title = "Average Rents",
       subtitle = "HUD Fair Market Rent Average and Zillow Observed Rent Index Average",
       x = "Year",
       y = "Rent",
       color = "Source") +
  theme_minimal()

### --------------
### ZIP/Rent dist plot
### TODO


### ------------------
### YoY diff map
### TODO


```

Finally, we'll want to take the above analysis and tie it back to the policy implications. We know HUD FMR data is used to guide housing subsidies. What does that mean in terms of the rental housing market, tenant precarity, and larger trends of income and housing inequality? If we have time I think it would be good to bring in some census data at the ZCTA level and looking to see if there is any association between demographics and housing affordability using this data.

```{r}
# TODO: Time permitting, link existing data with census data on socioeconomic characteristics

# ACS tables being queried by TidyCensus
tables <- c("Sex by Age" = "B01001",
            "Race" = "B02001",
            "Median Household Income" = "B19013")
```

```{r}
### --------------
### Sankey graph
###
# This can be used to visualize the change in housing stock composition overtime by ZIP code or something
```




