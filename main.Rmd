---
title: "The Rent is Too Damn High"
author: "Ethan Jantz & Alex Kwan"
date: "4/17/2021"
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_float: true    
---

```{r setup,  message = FALSE, warning = FALSE}
# TODO: Ensure theme_minimal applied to all plots
# TODO: Create theme to apply to all plots with defined colors (could just be viridis or whatever)
# TODO: Tables in places where a TODO: Put kable is found
# TODO: Update cleveland plot to reflect available socio-economic data
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(gganimate) # Used to create an animated plot
# install.packages('gifski') necessary for animation to compile
library(ggrepel) # Used to create cleveland dot plot
library(here)
library(patchwork) # Used to arrange plots as one image
library(sf) # Used to manipulate the spatial data for maps
library(tidycensus) # Used to pull census data 
library(tidyverse)
library(tigris) # Used to pull spatial features
library(UpSetR) # For plotting missing data
library(visdat) # For plotting missing data

# Ingests and cleans the HUD data
# Creates the object hud_data_raw in env
# Source: https://www.huduser.gov/portal/datasets/fmr.html
# Methodology: https://www.huduser.gov/portal/sites/default/files/pdf/fmr-overview.pdf
# NOTE: some years have more ZIP codes than others in this data
source(here("ingest_hud_data.R")) # creates hud_data_raw object in env

# Zillow Observed Rent Index (ZORI) data
# Source: https://www.zillow.com/research/data/
# NOTE: Not every ZIP code in Chicago is included in this data
zori_raw <- read_csv(here("Data", "ZORI_AllHomesPlusMultifamily_SSA_ZIP.csv")) %>%
  filter(RegionName %in% hud_data_raw$ZIP) # 92 ZIP Codes
```

# Introduction

Housing is a [social determinant of health](https://health.gov/healthypeople/objectives-and-data/social-determinants-health). Affordable housing is related to better [health outcomes for tenants](https://www.rupco.org/wp-content/uploads/pdfs/The-Impacts-of-Affordable-Housing-on-Health-CenterforHousingPolicy-Maqbool.etal.pdf), freeing money up for better nutrition, daycare and healthcare, and other necesities for individual wellbeing. Evictions are related to [poor health outcomes](https://www.bu.edu/sph/news/articles/2018/the-hidden-health-crisis-of-eviction/). Housing instability has been found to lead to higher stress levels, increased rates of depression and anxiety, and increased likelihood of living in lower quality housing or homelessness. Because of this, it is important to understand current metrics for what constitutes affordable housing. This project explores housing affordability through federal government metrics used to calculate housing subsidies known as Fair Market Rent (FMR).

Fair Market Rent is determined by a combination of a census survey of rents paid by recent movers, rent inflation adjustment, and forecasted expected growth in the rental housing market. FMR includes contract rent and utilities, ensuring that a full cost of base living necessities are captured in the metric. FMR calculations are made using American Community Survey from two years prior to the calculation and are primarily used to set public housing flat rates and Section 8 housing choice voucher payment standards. [Housing choice voucher recipients](https://www.huduser.gov/portal/sites/default/files/pdf/fmr-overview.pdf) and [public housing tenants](https://www.huduser.gov/periodicals/ushmc/spring95/spring95.html) make up approximately 3 million, or 2.5%, of United States households. Because of the diversity of contexts in which it is utilized, HUD FMR calculations can serve as a lens into the effectiveness of housing markets across the country in addressing issues of housing provision. This project aims to describe public data sources that can be used in analyzing housing affordability and some simple [indicators](https://urbanspatial.github.io/PublicPolicyAnalytics/TOD.html) that can be applied at various scales using Chicago as a case study.

## Research Questions

- What public data exists that can be used to develop indicators for housing affordability?

- What visualizations are effective in describing housing affordability, housing subsidies, and housing market dynamics?

- Are the U.S. Department of Housing and Urban Developmentâ€™s Fair Market Rent calculations representative of actual rents in Chicago?

- How have Fair Market Rent calculations and Zillow Observed Rent Index values changed over the period of 2014 to 2019 in Chicago?

- Do socio-economic characteristics such as rent burden, gini index values, and educational attainment have an association with housing affordability?

## Data

To perform this analysis, we needed data from three sources: 

- Fair Market Rent (FMR) data from the United States Department of Housing and Urban Development (HUD)

- Observed rent data provided by Zillow

- Socio-economic data provided by the United States Census in their American Community Survey data product

- Geographic data describing the boundaries of ZIP codes within our study area provided by the Census Bureau 

All of these data needed to be available at the same geographic level, and thankfully that provided no challenge as all of these data products are aggregated to the ZIP code level and the Metropolitan Statistical Area level. For this project we focused our efforts on ZIP codes within the City of Chicago. HUD FMR data is available through the [HUD Policy Development & Research Website](https://www.huduser.gov/portal/datasets/fmr.html), Zillow data is available through their [website's research data page](https://www.zillow.com/research/data/), and socio-economic data was available through the Census data API which we accessed using Kyle Walker's [TidyCensus](https://walker-data.com/tidycensus/) package. 

# Methods

The following section describes methods used to wrangle and analyze the public data described above. All of the following methods were performed using R and various open source packages developed by the R community. 

## Data Wrangling

### Housing Market Data

Zillow's ZORI data provides average observed rents without regard for the number of bedrooms within. HUD provides FMR calculations for each bedroom size. To compare these two datasets we averaged the FMR for each bedroom size (studio through 4 bedroom) together to create an average FMR for the ZIP code. This method was chosen for its relative simplicity, with proposed alternatives including a weighted average with weights tied to bedroom size or the selection of one bedroom size as the standard for comparison. 

HUD FMR data was collected at the ZIP code level, with calculations being made for each year in the study period. Zillow data was provided for each month within the study period. To compare data across the same unit of time, we transformed the ZORI data and averaged the monthly values to approximate a year average for each ZIP code. 

HUD data was clean and complete, meaning that no rows contained any missing values and represented 487 ZIP codes within the Chicago metropolitan region across the 7 year study period. Zillow data was far more limited, sharing only 92 ZIP codes with the HUD data and missing many values within those ZIP codes for certain time periods within our study period. The differences in these data sets limit the generalizability of the analysis, and is discussed more in the limitations section below.

```{r }
### --------------
### hud data
###

hud_data <- hud_data_raw %>%
  # Create a variable to compare with ZORI values
  mutate(br_avg = (br_0 + br_1 + br_2 + br_3 + br_4) / 5) %>% 
  select(!c(br_0:br_4)) %>%
  # saw some duplicates on the year-zip level
  distinct()

### ------------
### zori data
###

zori_staging <- zori_raw %>%
  filter(RegionName %in% hud_data_raw$ZIP) %>% # 92 ZIP Codes
  pivot_longer(cols = "2014-01":"2020-12",
               names_to = c("year","month"),
               names_sep = "-",
               values_to = "rent",
               names_transform = list(year = as.double)) %>%
  select("RegionName","year","month","rent") 

zori <- zori_staging %>%
  group_by(RegionName, year) %>%
  summarize(rent_avg = mean(rent, na.rm = TRUE)) %>%
  ungroup()

rm(zori_staging)

### -----------
### market data
###

data <- zori %>%
  left_join(hud_data, by = c("RegionName" = "ZIP", "year" = "year")) %>%
  rename(hud_avg = br_avg, zori_avg = rent_avg)

# TODO: KableExtra table with quick summary stats of data object
```

### Socio-Economic Data

To place the housing market data into better context we combined it with socio-economic data provided by the US Census Bureau's American Community Survey. ZIP code-level data is provided only in their 5 year estimate data products, which limited our ability to thoroughly analyze changes over 1 year time periods. To accommodate this limitation we pulled the data for two non-overlapping 5 year estimates, 2014 and 2019, and used them to supplement our findings.



```{r}
### -----------------------
### Census data
###

# Defines acs5_pull function, lists the variables used, and calculates values with those variables
source(here("ingest_census_data.R"))

zips <- data %>%
  pull(RegionName) %>%
  unique()

acs_2014 <- acs5_pull(2014, zips) %>%
  # Including zips in the function call is supposed to prevent us needing
  # to filter by zip, but it's not working.
  mutate(ZIP = str_extract(NAME, "[0-9]{5}?")) %>%
  filter(ZIP %in% zips)

acs_2019 <- acs5_pull(2019, zips) %>%
  mutate(ZIP = str_extract(NAME, "[0-9]{5}?")) %>%
  filter(ZIP %in% zips)

data_2014 <- data %>%
  filter(year == 2014) %>%
  left_join(acs_2014, by = c("RegionName" = "ZIP", "year"))

data_2019 <- data %>%
  filter(year == 2019) %>%
  left_join(acs_2019, by = c("RegionName" = "ZIP", "year"))

# TODO: KableExtra table with basic summary statistics for data_2019
```

### Spatial Data

There may be a spatial component that would be necessary to understand the dynamics present within our data. To explore this we used the `tigris` package to acquire spatial data that would allow us to map the research data to real space. Spatial data was then joined to our research data for the purpose of visualizing the changes in the data over time in a way that allows a layperson to digest geographic differences. Because of Chicago's history of racial segregation leading to extreme spatial inequality, this research project serves as a testing ground to see if socio-economic differences play a part in the dynamics between observed rents and federal housing subsidies. The following map shows the location and area of ZIP codes included in the research data.

```{r }
### -----------------------------
### Spatial Data
### 

# Transforming to this CRS makes the map look "normal"
crs <- 3435 # coordinate reference system: IL NAD83 East

# Get Cook County geometry to put zctas in context
cook_county <- counties(state = "IL", cb = T, progress_bar = F) %>%
  filter(NAME == "Cook") %>% # Chicago + suburbs are almost entirely within Cook County
  select(NAME, geometry) %>%
  st_transform(crs)

# Create filter for ZIP geom pull
starts_with <- data %>% 
  pull(RegionName) %>% # Vectorize the column
  str_extract(pattern = "[0-9]{2}") %>%
  unique() # c("53", "60") 

### Get ZCTA geometry
zcta <- zctas(cb = T, starts_with = starts_with, progress_bar = F) %>%
  select(GEOID10, geometry) %>%
  st_transform(crs) %>% # Without this transformation to ILNAD83 the map looks weird
  st_filter(cook_county) # There are ZIP codes that fall outside of Cook county
                         # and make the map harder to digest. st_filter removes them

# Instead of a summary table include a map showing where the geographies are located
data %>%
  left_join(zcta, by = c("RegionName" = "GEOID10")) %>%
  ggplot(aes(geometry = geometry)) +
  geom_sf(data = cook_county) + # County boundary
  geom_sf(aes(fill = RegionName)) + # ZCTA boundaries
  labs(title = "Map of ZIP Codes in Research Data",
       subtitle = "colors included for legibility purposes only") +
  theme_minimal() +
  guides(fill = FALSE) # remove legend
```

## Analysis

### Macro-Level Trends

The following plot shows the aggregate trend lines of observed rents and FMR values. Observed rents increased over time, which is to be expected due to growth. FMR values typically lag behind observed rents, which is why the two trend lines are parallel. This is due to the fact that HUD FMR values are calculated using rent estimates from ACS 5 year gross rent estimates from two years prior to the year of valuation, omitting new construction from the observed rental housing stock. The shortening of the gap between the two values in 2018 was due to a [change in methodology](https://www.huduser.gov/portal/datasets/fmr/fmr2018/FY2018-FMR-Preamble.pdf) by HUD. In 2018, the FMR calculation stopped using 50th percentile FMR values and began using 40th percentile FMR values. While describing the impacts and outcomes of this change is not within the scope of this project, it is worth noting that this likely increased the mobility of households receiving federal housing subsidies. 

```{r }
### -----------
### Trend plot
###

data %>%
  group_by(year) %>%
  summarize(ZORI = mean(zori_avg, na.rm = T),
            HUD = mean(hud_avg, na.rm = T)) %>%
  pivot_longer(cols = c(ZORI:HUD),
               names_to = "index",
               values_to = "rent") %>%
  ggplot(aes(x = year, y = rent, color = index)) +
  geom_line(size = 2, lineend = "round") +
  labs(title = "Average Values, Fair Market Rent and Observed Rents, 2014 - 2020",
       subtitle = "HUD Fair Market Rent Average and Zillow Observed Rent Index Average",
       x = "Year",
       y = "Rent (in USD)",
       color = "Values") +
  theme_minimal() +
  scale_y_continuous(labels = scales::label_dollar())
```

These general trends in Chicago's rental housing market demonstrate that, on average, rent is increasing in the city. Housing subsidies follow similar trends, but never match those of observed rents. This indicates that households with the most need, those that receive rental subsidies, are chronically unable to afford high-quality housing in Chicago.

### Pulling Out the Magnifying Glass

The general trends described above provide insight into Chicago as a whole, opening up questions about whether these trends are experienced equally across Chicago ZIP codes. 

An [article](https://www.nhlp.org/wp-content/uploads/2018/05/AH-27-1_11Thrope.pdf) written by Deborah Thrope in the *Journal of Affordable Housing* titled *Achieving Housing Choice and Mobility in the Voucher Program* outlined the inadequacies of the Housing Choice Voucher program in enabling tenant mobility and a collection of policy prescriptions to improve outcomes. Among them was a recommendation that HUD use Small Area FMR (SAFMR) values to better account for local market conditions. 

The following animation visualizes the difference between observed rent and FMR values over time for ZIP codes (Note: SAFMR and ZIP Code are used interchangeably in this report) where data was available. Please note that because of the way the difference was calculated it is not immediately apparent whether changes are due to a shift in HUD data, Zillow data, or both. 

```{r }
### -----------------------------
### Year-over-Year difference map
### Animated

map_anim <- data %>%
  mutate(diff = zori_avg - hud_avg) %>% 
  left_join(zcta, by = c("RegionName" = "GEOID10")) %>%
  ggplot(aes(geometry = geometry)) +
  geom_sf(data = cook_county) + # County boundary
  geom_sf(aes(fill = diff)) + # ZCTA map
  labs(title = "Year: {current_frame}", # Adds the year value to the title through interpolation
       fill = "ZORI - HUD Value") + 
  scale_fill_viridis_c() +
  theme_minimal() +
  transition_manual(year) # transition_time doesn't work well with sf for some reason

animate(map_anim, fps = 1, nframes = 6)
```

The following distribution plots help us understand that the change in the difference between ZORI values and HUD FMR is an effect of FMR increasing, not ZORI decreasing. What does this mean for housing affordability? This could indicate that HUD voucher recipients are being provided a wider range of places to move to as HUD FMR begins to match average rents.

```{r}
### --------------------------
### ZIP/Rent distribution plot
### Animated

dist_anim <- data %>% 
  group_by(RegionName, year) %>%
  summarize(ZORI = mean(zori_avg, na.rm = T),
         HUD = mean(hud_avg, na.rm = T)) %>%
  ggplot() +
  geom_density(aes(x = ZORI), fill = "blue", alpha = .5) +
  geom_density(aes(x = HUD), fill = "red", alpha = .5) +
  labs(title = "Distribution of Rent Values by ZIP Code, {current_frame}",
       subtitle = "blue is ZORI, red is HUD",
       x = "Rent", 
       y = "Density") +
  theme_minimal() +
  transition_manual(year)

animate(dist_anim, fps = 1, nframes = 6)
```

The above animations show that not every SAFMR value is equally responsive to market conditions, even when larger trends indicate progress towards intended outcomes. ZIP Codes in some areas saw relatively little change in the difference between their observed rents and calculated FMR values, while others saw drastic changes over the same time period - shifting from a large positive value to a negative value. This may indicate inefficiencies in the data and methods used to calculate SAFMR since an ideal model of FMR calculation would result in a relatively homogeneous set of difference values across all areas. Further exploration of these differences could take the form of a case study of areas where the difference value was positive and saw little change across the study period compared with those where the difference value was close to negative and saw little change across the study period. The following section attempts to explore a methodological avenue for doing such a case study.

### Examining the Edges: Largest Differences in FMR Calculations and Observed Rents

The following section performs a brief case study of the areas with the largest differences at the beginning of our study period, 2014. One notable theme in this set was gentrification. Five of the ten ZIP codes in this case study contained areas that were known to be gentrifying or at risk of gentrification in [this](https://voorheescenter.red.uic.edu/wp-content/uploads/sites/122/2017/10/Voorhees-Center-Gentrification-Index-Oct-14.pdf) study performed by the Nathalie P. Voorhees Center at UIC - Logan Square, Pilsen, Cabrini Green, Chinatown, and East Garfield Park. Expanding on this case study could provide more explanatory or descriptive factors in gentrification research.

To add some context to this issue we combined our market data with socio-economic data and examined the trend in income changes over time as compared to rent for the ZIP codes with the largest difference in ZORI and FMR values in 2014. Because the Census Bureau recommends not comparing overlapping 5-year survey estimates, and because ZIP code-level data is unavailable in 1-year survey data, this approach is unable to provide a granular time-series analysis of the relationships between socio-economic characteristics and the market data. The following table lists those ZIP codes and their associated town or neighborhood. Label values were defined using Google Maps and assigning names based on which names appeared within the ZIP code boundaries.

```{r}
# Defines labels for ZIP codes
neighborhoods <-
  list(
    "60045" = "Lake Forest, IL",
    "60602" = "Downtown",
    "60610" = "Near Northside, Cabrini Green",
    "60126" = "Elmhurst, IL",
    "60642" = "River West",
    "60647" = "Logan Square",
    "60616" = "Chinatown, Armour Square, Bridgeport",
    "60525" = "La Grange, IL",
    "60612" = "East Garfield Park",
    "60608" = "Pilsen",
    "60538" = "Aurora, IL"
  )

# TODO: make this into kable
data %>%
  mutate(diff = (zori_avg - hud_avg)/hud_avg) %>%
  ungroup() %>%
  filter(year == 2014) %>%
  arrange(desc(diff)) %>%
  slice(head(row_number(), 10)) %>%
  select(RegionName) %>%
  mutate(neighborhood = as.character(neighborhoods[RegionName]))
```

The following plots visualize the change in the selected ZIP codes between 2014 and 2019 in terms of observed minus fair market rent values and rent burden. Rent burden is defined by HUD as a tenant's gross rent being greater than 30% of their income. Any rent above 50% of tenant income is considered to be a severe rent burden. The lines between the plotted values are colored based on whether the proportion of households in the ZIP code area were majority or minority rent burdened. 

```{r fig.width=10, fig.height=11}
### ------------------
### Cleveland Dot Plot 
### 

cleveland_data <-
  data %>%
  mutate(diff = (zori_avg - hud_avg)/hud_avg) %>%
  ungroup() %>%
  filter(RegionName %in% names(neighborhoods) & year %in% c(2014,2019)) %>%
  pivot_longer(cols = c(zori_avg:hud_avg),
               names_to = "source",
               values_to = "rent") %>%
  mutate(neighborhood = neighborhoods[RegionName])

acs_to_year_mapping <- list(
  "2014" = data_2014,
  "2019" = data_2019
)

cleveland_plot <- function(input_data, yr, acs) {
  plot_data <-
    input_data %>%
    left_join(acs[[as.character(yr)]], by = c("RegionName", "year")) %>%
    filter(year == yr) %>%
    mutate(burden = cut(percent_unaffordable,
                        breaks=c(0, 0.5, 1),
                        labels=c("Minority","Majority")))
  
  ggplot(data = plot_data,
         mapping = aes(x = RegionName, y = rent)) +
    # line showing the difference between the HUD and Zillow indices
    geom_line(aes(group = RegionName, color = burden), size = 5) +
    # shapes representing either HUD or Zillow index
    geom_point(aes(shape = source), size = 5) +
    # labeling the difference by percentage between indices
    geom_text(
      data = plot_data %>% filter(source == "zori_avg"),
      mapping = aes(label = paste0("", scales::percent(x = percent_unaffordable, 
                                                       accuracy = 0.01)),
                    color = burden),
      size = 3.5,
      hjust = -0.25
    ) +
    # labeling the lines
    geom_text(
      data = plot_data %>% filter(source == "hud_avg"),
      mapping = aes(label = neighborhood),
      size = 3.5,
      hjust = 0,
      nudge_x = 0.5
    ) +
    scale_y_continuous(labels = scales::dollar_format(),
                       limits = c(800, 3200)) +
    coord_flip() +
    labs(
      title = paste0("Fair and Market Rate Differences by ZIP, ", yr),
      subtitle = "HUD versus Zillow with Proportion of Population Rent Burdened",
      x = "ZIP",
      y = "Rent Index",
      shape = "Source",
      color = "Proportion"
    ) +
    # Proper labels with aesthetics
    scale_color_manual(values = c("Minority"="#00ba38","Majority"="#F8766D")) +
    scale_shape_manual(values = c("circle","square"), labels = c("HUD", "Zillow"))
}

cleveland_plot(cleveland_data, 2014, acs_to_year_mapping) / cleveland_plot(cleveland_data, 2019, acs_to_year_mapping)
```

### Socio-Economic Characteristic Context

In comparing 2014 to 2019 we found that the neighborhoods typically known for gentrification have some of the largest differences in market rates. This is especially true in regards to neighborhoods that were historically marginalized due to segregation and disinvestment. Adding in the income data we see that while incomes for areas like Downtown have increased over time, thereby reducing the rent burden, but the incomes in the marginalized areas have not proportionally increased.

```{r}
### -------------------
### coor plot
### diff and hh_income
# TODO: Do the same with gini_index and percent_black_pop

plot1 <- data_2014 %>%
  mutate(diff = zori_avg - hud_avg) %>%
  ggplot(aes(x = median_hh_income, y = diff)) +
  geom_jitter() +
  geom_smooth(method = "lm") +
  labs(title = "Observed Minus Fair Market Rent Compared with Household Income, 2014",
      x = "Median Household Income",
      y = "ZORI - FMR Values (in USD)") +
  scale_x_continuous(limits = c(0, 190000)) + 
  theme_minimal()

plot2 <- data_2019 %>%
  mutate(diff = zori_avg - hud_avg) %>%
  ggplot(aes(x = median_hh_income, y = diff)) +
  geom_jitter() +
  geom_smooth(method = "lm") +
  labs(title = "Observed Minus Fair Market Rent Compared with Household Income, 2019",
      x = "Median Household Income",
      y = "ZORI - FMR Values (in USD)") +
  scale_x_continuous(limits = c(0, 190000)) + 
  theme_minimal()

plot1 / plot2
```

# Conclusions

## Limitations

Differences between ZORI and FMR data, missing ZORI values for some months could effect the generalizability of rents for some years.

Dollar values aren't inflation adjusted, which would be important for a more in-depth analysis. However, since \$1000 in 2014 is equivalent to \$1118.87 today we can ignore it without running into any major methodological issues.

### Missingness in data

```{r fig.width=12, fig.height=6}
# TODO: Visualize missingness in zori data. This could use zori_raw or zori_staging I think. Whichver works best. Have to figure out to label the year lines.

vis_miss(zori_raw %>% select(c("2014-01":"2021-02"))) + 
  geom_vline(xintercept = seq(from = 0, to = 94, by = 12), size = 1) +
  # geom_text(aes(x=seq(from = 0, to = 94, by = 12), label="test", y=0), colour="#00ba38", angle=0, text=element_text(size=11)) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme_minimal()
```

We see here that missing data is much more of a concern for the first couple years, 2014 and 2015, especially in the upper range of rents, but less of an issue for the later years. This missing data seems to be Missing at Random, or MAR, since there doesn't seem to be any specific mechanism linking the missingness of rental data to those particular periods.

After the join between HUD and Zillow data, we find that Zillow has data on some years that HUD doesn't, but it was not enough to cause concern with only 3 values missing in the three most recent years.

```{r fig.width=10, fig.height=5}
vis_miss(data %>% select(zori_avg, hud_avg)) +
  ggplot(data %>% 
           group_by(year) %>%
           summarise(n_missing = sum(is.na(hud_avg)))) +
  geom_bar(aes(x = year, y = n_missing), stat="identity") + 
  # TODO: show every year on x axis
  scale_y_continuous(limits = c(0,5)) +
  theme_minimal()
```


## Findings

HUD FMR jumped significantly from 2017 to 2018. We should look into why that happened. 

### Policy Implications

### Further Questions