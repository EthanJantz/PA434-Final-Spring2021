---
title: "The Affordable Housing Crunch"
author: "Ethan Jantz & Alex Kwan"
date: "4/17/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup,  message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(gganimate) # Used to create an animated plot
library(here)
library(patchwork) # Used to arrange plots as one image
library(sf) # Used to mainpulate the spatial features
library(tidycensus) # Used to pull census data 
library(tidyverse)
library(tigris) # Used to pull spatial features

# Ingests and cleans the HUD data
# Creates the object hud_data_raw in env
# Source: https://www.huduser.gov/portal/datasets/fmr.html
# Methodology: https://www.huduser.gov/portal/sites/default/files/pdf/fmr-overview.pdf
# NOTE: some years have more ZIP codes than others in this data
# TODO: Find out which ZIPs are included in all data
source(here("ingest_hud_data.R"))

# Zillow Observed Rent Index (ZORI) data
# Source: https://www.zillow.com/research/data/
# NOTE: Not every ZIP code in Chicago is included in this data, we'll probably have to 
# identify some set of ZIP codes in both datasets and use those
# as a case study
zori_raw <- read_csv(here("Data", "ZORI_AllHomesPlusMultifamily_SSA_ZIP.csv")) %>%
  filter(RegionName %in% hud_data_raw$ZIP) # 92 ZIP Codes
```

# Background

Why is affordable housing important? Housing as a social determinant of health. Affordable housing being related to better health outcomes for tenants. Evictions being related to poor health outcomes. Rental affordability as the average rent in relation to what HUD determines to be the Fair Market Rent, and what that means about affordability. Fair Market Rent, or FMR, is determined by a combination of a Census survey of rents paid by recent movers, rent inflation adjustment and forecasted expected growth.

# Research Questions

- Is the U.S. Department of Housing and Urban Developmentâ€™s Fair Market Rent calculations representative of actual rents in an area?
- If there is a difference between actual rents and Fair Market Rents as determined by HUD, what data can we use to explain those differences?

# Data Plan

Discrepancies in data availability. Some ZIP codes are missing values for some years in the ZORI data, some HUD data is missing data for ZIP Codes across years.

Time permitting add census demographic data from the ACS.

# Analysis Plan

Zillow's ZORI data provides average rents across all units, **regardless of the number of bedrooms**. We need some method to compare ZORI values with the values provided by HUD. This could take the form of finding the best fitting bedroom size or collapsing the HUD bedroom values into one average value. We can try both and see what works best.

```{r }

### The final dataset should have no missing values for a ZIP code in any year. That means that the ZIP codes should have values for all years in the the hud and zori datasets.

### --------------
### hud data
###

hud_data <- hud_data_raw %>%
  # Create a variable to map to the ZORI values
  mutate(br_avg = (br_0 + br_1 + br_2 + br_3 + br_4) / 5) %>% 
  select(!c(br_0:br_4)) %>%
  # saw some duplicates on the year-zip level
  distinct()

### ------------
### zori data
###

zori_staging <- zori_raw %>%
  filter(RegionName %in% hud_data_raw$ZIP) %>% # 92 ZIP Codes
  pivot_longer(cols = "2014-01":"2020-12",
               names_to = c("year","month"),
               names_sep = "-",
               values_to = "rent",
               names_transform = list(year = as.double)) %>%
  select("RegionName","year","month","rent") 

# quite a bit of missing data, ignoring issue for now
# zori_staging %>%
#   group_by(RegionName, year) %>%
#   summarize(rent_missing_prop = sum(is.na(rent))/12)

zori <- zori_staging %>%
  group_by(RegionName, year) %>%
  summarize(rent_avg = mean(rent, na.rm = TRUE)) %>%
  ungroup()

rm(zori_staging)

### -----------
### combined
###

data <- zori %>%
  left_join(hud_data, by = c("RegionName" = "ZIP", "year" = "year")) %>%
  rename(hud_avg = br_avg, zori_avg = rent_avg)
```

# Plots

Once we have both our data fully cleaned we'll want to do some basic visualizations of the data. I see this taking the form of a distribution plot across ZIP codes by year, a series of maps by year, and trend lines of ZORI values and FMR values.

```{r }
### -----------
### Trend plot
###
# Shows the parallel aggregate trend lines between observed rents and HUD's FMR values 
# average across ZIP codes observed in data. We need to explain what this is,
# and why it's the case. It's because FMR is derived from actual rents, and
# the process for determining FMR excludes the newest housing stock (buildings
# constructed in the past 2 years). 
data %>%
  group_by(year) %>%
  summarize(ZORI = mean(zori_avg, na.rm = TRUE),
            HUD = mean(hud_avg, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ZORI:HUD),
               names_to = "index",
               values_to = "rent") %>%
  ggplot(aes(x = year, y = rent, color = index)) +
  geom_line(size = 2, lineend = "round") +
  labs(title = "Average Rents",
       subtitle = "HUD Fair Market Rent Average and Zillow Observed Rent Index Average",
       x = "Year",
       y = "Rent",
       color = "Source") +
  theme_minimal()
```


```{r }
### ------------------
### Cleveland Dot Plot
### 
library(ggrepel)

neighborhoods <-
  list(
    "60045" = "Lake County",
    "60602" = "Downtown",
    "60610" = "Near Northside, Cabrini Green",
    "60126" = "Elmhurst",
    "60642" = "River West",
    "60647" = "Palmer Square",
    "60616" = "Chinatown, Armour Square",
    "60525" = "La Grange",
    "60612" = "East Garfield Park",
    "60608" = "Pilsen"
  )

cleveland_data <-
  data %>%
  filter(year == 2017) %>%
  # can't do functions in label assignments so gotta do it here
  mutate(diff = (zori_avg - hud_avg)/hud_avg) %>%
  ungroup() %>%
  slice_max(order_by = diff, n = 9, with_ties = FALSE) %>%
  pivot_longer(cols = c(zori_avg:hud_avg),
               names_to = "source",
               values_to = "rent") %>%
  mutate(neighborhood = neighborhoods[RegionName])

cleveland_plot <- ggplot(data = cleveland_data,
                         mapping = aes(x = reorder(RegionName, rent), 
                                       y = rent)) +
  geom_line(aes(group = RegionName), size = 1) +
  geom_point(aes(color = source), size = 5) +
  geom_text(data = cleveland_data %>% filter(source == "zori_avg"),
            mapping = aes(color = source,
                          label = paste0("+",scales::percent(x = diff, 
                                                             accuracy = 0.01))),
            size = 3.5,
            hjust = -0.25) +
  geom_text(data = cleveland_data %>% filter(source == "hud_avg"),
            mapping = aes(label = neighborhood),
            size = 3.5,
            hjust = 0,
            nudge_x = 0.5) +
  scale_y_continuous(labels = scales::dollar_format(), limits = c(800, 3200)) +
  coord_flip() +
  labs(title = "Zip Codes With Rent Furthest From Fair Market Rate",
       subtitle = "HUD versus Zillow",
       x = "ZIP",
       y = "Rent Index",
       color = "Source") +
  scale_colour_discrete(labels = c("HUD", "Zillow"))

rm(cleveland_data)

cleveland_plot
```

# Exploring Change in Rent Valuations

The following map shows that the difference between ZORI and HUD FMR values has been shrinking, and in some places reversing. 

```{r }
### -----------------------------
### Year-over-Year difference map
### Animation

# Transforming to this CRS makes the map look "normal"
crs <- 3435 # coordinate reference system: IL NAD83 East

# Get Cook County geometry to put zctas in context
cook_county <- counties(state = "IL", cb = T) %>%
  filter(NAME == "Cook") %>% # Chicago + suburbs are almost entirely within Cook County
  select(NAME, geometry) %>%
  st_transform(crs)

cook_coords <- st_coordinates(cook_county)

# Create filter for ZIP geom pull
starts_with <- data %>% 
  pull(RegionName) %>% # Vectorize the column
  str_extract(pattern = "[0-9]{2}") %>%
  unique() # c("53", "60") 

### Get ZCTA geometry
zcta <- zctas(cb = T, starts_with = starts_with) %>%
  select(GEOID10, geometry) %>%
  st_transform(crs) %>% # Without this transformation to ILNAD83 the map looks weird
  st_filter(cook_county) # There are ZIP codes that fall outside of Cook county
                         # that make the map less easy to digest. This removes them

map_anim <- data %>%
  # NOTE: Because of the way this is calculated we don't 
  # have any indication if the change is due to a change in 
  # ZORI or HUD values
  mutate(diff = zori_avg - hud_avg) %>% 
  left_join(zcta, by = c("RegionName" = "GEOID10")) %>%
  ggplot(aes(geometry = geometry)) +
  geom_sf(data = cook_county) + # County boundary
  geom_sf(aes(fill = diff)) + # ZCTA map
  labs(title = "Year: {current_frame}", # Adds the year value to the title through interpolation
       caption = "In some ZIP codes, the difference between ZORI and HUD FMR has changed drastically",
       fill = "ZORI - HUD") + 
  scale_fill_continuous() +
  theme_minimal() +
  transition_manual(year) # transition_time doesn't work well with sf for some reason

animate(map_anim, fps = 1, nframes = 6)
```

The following distribution plots help us understand that this is an effect of HUD FMR increasing, not ZORI decreasing. What does this mean for housing affordability? This could mean that HUD voucher recipients are being provided a wider range of places to move to as HUD FMR begins to match average rents.

```{r }
### --------------
### ZIP/Rent distribution plot
###

# NOTE: These values aren't inflation adjusted, which would be important for a more in-depth analysis. 
# However, since $1000 in 2014 is equivalent to $1118.87 today we can ignore it without
# running into any major methodological issues.

# NOTE: This could be animated too 
data %>% 
  group_by(RegionName, year) %>%
  summarize(ZORI = mean(zori_avg),
         HUD = mean(hud_avg)) %>%
  ggplot() +
  geom_density(aes(x = ZORI), fill = "blue", alpha = .5) +
  geom_density(aes(x = HUD), fill = "red", alpha = .5) +
  labs(title = "Distribution of Rent Values by ZIP Code",
       subtitle = "blue is ZORI, red is HUD",
       x = "Rent", 
       y = "Density") +
  facet_wrap(~year)
```

# Incorporating Census Data

We'll want to take the above analysis and tie it back to the policy implications. We know HUD FMR data is used to guide housing subsidies. What does that mean in terms of the rental housing market, tenant precarity, and larger trends of income and housing inequality? If we have time I think it would be good to bring in some census data at the ZCTA level and looking to see if there is any association between demographics and housing affordability using this data.

```{r}
# This entire section could be cleaned up, but it works.

source(here("ingest_census_data.R"))

zips <- data %>%
  pull(RegionName) %>%
  unique()

acs_2014 <- acs5_pull(2014, zips) %>%
  # Including zips in the function call is supposed to prevent us needing
  # to filter by zip, but it's not working.
  mutate(ZIP = str_extract(NAME, "[0-9]{5}?")) %>%
  filter(ZIP %in% zips)

acs_2019 <- acs5_pull(2019, zips) %>%
  mutate(ZIP = str_extract(NAME, "[0-9]{5}?")) %>%
  filter(ZIP %in% zips)

# TODO: This can be put into one dataset so that we can
# analyze change over time
data_2014 <- data %>%
  filter(year == 2014) %>%
  left_join(acs_2014, by = c("RegionName" = "ZIP", "year"))

data_2019 <- data %>%
  filter(year == 2019) %>%
  left_join(acs_2019, by = c("RegionName" = "ZIP", "year"))
```

## Plotting Associations

```{r}
### -------------
### coor plot
### ZORI and hh_income

plot1 <- data_2014 %>%
  ggplot(aes(x = median_hh_income, y = zori_avg)) +
  geom_jitter() +
  geom_smooth(method = "lm") +
  labs(title = "Observed Rents and Household Income, 2014",
      subtitle = "for select ZIP Codes",
      x = "Median Household Income",
      y = "Zillow Observed Rent Index Value")

plot2 <- data_2019 %>%
  ggplot(aes(x = median_hh_income, y = zori_avg)) +
  geom_jitter() +
  geom_smooth(method = "lm") +
  labs(title = "Observed Rents and Household Income, 2019",
      subtitle = "for select ZIP Codes",
      x = "Median Household Income",
      y = "Zillow Observed Rent Index Value")

plot1 + plot2
```


```{r}
### --------------
### Sankey graph
###
# This can be used to visualize the change in housing stock composition overtime by ZIP code or something
```


# Limitations

## Missingness in data

# Conclusions

## Findings

## Further Questions