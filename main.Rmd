---
title: "The Rent is Too Damn High"
author: "Ethan Jantz & Alex Kwan"
date: "4/17/2021"
output:
  html_document: 
    code_folding: hide
---

```{r setup,  message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(gganimate) # Used to create an animated plot
# install.packages('gifski') necessary for animation to compile
library(ggrepel) # Used to create cleveland dot plot
library(here)
library(patchwork) # Used to arrange plots as one image
library(sf) # Used to manipulate the spatial data for maps
library(tidycensus) # Used to pull census data 
library(tidyverse)
library(tigris) # Used to pull spatial features
library(visdat) # For plotting missing data
library(UpSetR) # For plotting missing data

# Ingests and cleans the HUD data
# Creates the object hud_data_raw in env
# Source: https://www.huduser.gov/portal/datasets/fmr.html
# Methodology: https://www.huduser.gov/portal/sites/default/files/pdf/fmr-overview.pdf
# NOTE: some years have more ZIP codes than others in this data
source(here("ingest_hud_data.R"))

# Zillow Observed Rent Index (ZORI) data
# Source: https://www.zillow.com/research/data/
# NOTE: Not every ZIP code in Chicago is included in this data
zori_raw <- read_csv(here("Data", "ZORI_AllHomesPlusMultifamily_SSA_ZIP.csv")) %>%
  filter(RegionName %in% hud_data_raw$ZIP) # 92 ZIP Codes
```

# Introduction

Housing is a [social determinant of health](https://health.gov/healthypeople/objectives-and-data/social-determinants-health). Affordable housing is related to better [health outcomes for tenants](https://www.rupco.org/wp-content/uploads/pdfs/The-Impacts-of-Affordable-Housing-on-Health-CenterforHousingPolicy-Maqbool.etal.pdf), freeing money up for better nutrition, daycare and healthcare, and other necesities for individual wellbeing. Evictions are related to [poor health outcomes](https://www.bu.edu/sph/news/articles/2018/the-hidden-health-crisis-of-eviction/). Housing instability has been found to lead to higher stress levels, increased rates of depression and anxiety, and increased likelihood of living in lower quality housing or homelessness. Because of this, it is important to understand current metrics for what constitutes affordable housing. This project explores housing affordability through federal government metrics used to calculate housing subsidies known as Fair Market Rent (FMR).

Fair Market Rent is determined by a combination of a census survey of rents paid by recent movers, rent inflation adjustment, and forecasted expected growth in the rental housing market. FMR includes contract rent and utilities, ensuring that a full cost of base living necessities are captured in the metric. FMR calculations are made using American Community Survey from two years prior to the calculation and are primarily used to set public housing flat rates and Section 8 housing choice voucher payment standards. [Housing choice voucher recipients](https://www.huduser.gov/portal/sites/default/files/pdf/fmr-overview.pdf) and [public housing tenants](https://www.huduser.gov/periodicals/ushmc/spring95/spring95.html) make up approximately 3 million, or 2.5%, of United States households. Because of the diversity of contexts in which it is utilized, HUD FMR calculations can serve as a lens into the effectiveness of housing markets across the country in addressing issues of housing provision. This project aims to describe public data sources that can be used in analyzing housing affordability and some simple [indicators](https://urbanspatial.github.io/PublicPolicyAnalytics/TOD.html) that can be applied at various scales using Chicago as a case study.

## Research Questions

- What public data exists that can be used to develop indicators for housing affordability?

- What visualizations are effective in describing housing affordability, housing subsidies, and housing market dynamics?

- Are the U.S. Department of Housing and Urban Developmentâ€™s Fair Market Rent calculations representative of actual rents in Chicago?

- How have Fair Market Rent calculations and Zillow Observed Rent Index values changed over the period of 2014 to 2019 in Chicago?

- Do socio-economic characteristics such as rent burden, gini index values, and educational attainment have an association with housing affordability?

## Data

To perform this analysis, we needed data from three sources: 

- Fair Market Rent (FMR) data from the United States Department of Housing and Urban Development (HUD)

- Observed rent data provided by Zillow

- Socio-economic data provided by the United States Census in their American Community Survey data product

- Geographic data describing the boundaries of ZIP codes within our study area provided by the Census Bureau 

All of these data needed to be available at the same geographic level, and thankfully that provided no challenge as all of these data products are aggregated to the ZIP code level and the Metropolitan Statistical Area level. For this project we focused our efforts on ZIP codes within the City of Chicago. HUD FMR data is available through the [HUD Policy Development & Research Website](https://www.huduser.gov/portal/datasets/fmr.html), Zillow data is available through their [website's research data page](https://www.zillow.com/research/data/), and socio-economic data was available through the Census data API which we accessed using Kyle Walker's [TidyCensus](https://walker-data.com/tidycensus/) package. 

# Methods

The following section describes methods used to wrangle and analyze the public data described above. All of the following methods were performed using R and various open source packages developed by the R community. 

## Data Wrangling

### Housing Market Data

Zillow's ZORI data provides average observed rents without regard for the number of bedrooms within. HUD provides FMR calculations for each bedroom size. To compare these two datasets we averaged the FMR for each bedroom size (studio through 4 bedroom) together to create an average FMR for the ZIP code. This method was chosen for its relative simplicity, with proposed alternatives including a weighted average with weights tied to bedroom size or the selection of one bedroom size as the standard for comparison. 

HUD FMR data was collected at the ZIP code level, with calculations being made for each year in the study period. Zillow data was provided for each month within the study period. To compare data across the same unit of time, we transformed the ZORI data and averaged the monthly values to approximate a year average for each ZIP code. 

HUD data was clean and complete, meaning that no rows contained any missing values and represented 487 ZIP codes within the Chicago metropolitan region across the 7 year study period. Zillow data was far more limited, sharing only 92 ZIP codes with the HUD data and missing many values within those ZIP codes for certain time periods within our study period. The differences in these data sets limit the generalizability of the analysis, and is discussed more in the limitations section below.

```{r }
### --------------
### hud data
###

hud_data <- hud_data_raw %>%
  # Create a variable to compare with ZORI values
  mutate(br_avg = (br_0 + br_1 + br_2 + br_3 + br_4) / 5) %>% 
  select(!c(br_0:br_4)) %>%
  # saw some duplicates on the year-zip level
  distinct()

### ------------
### zori data
###

zori_staging <- zori_raw %>%
  filter(RegionName %in% hud_data_raw$ZIP) %>% # 92 ZIP Codes
  pivot_longer(cols = "2014-01":"2020-12",
               names_to = c("year","month"),
               names_sep = "-",
               values_to = "rent",
               names_transform = list(year = as.double)) %>%
  select("RegionName","year","month","rent") 

# quite a bit of missing data, ignoring issue for now
# zori_staging %>%
#   group_by(RegionName, year) %>%
#   summarize(rent_missing_prop = sum(is.na(rent))/12)

zori <- zori_staging %>%
  group_by(RegionName, year) %>%
  summarize(rent_avg = mean(rent, na.rm = TRUE)) %>%
  ungroup()

# rm(zori_staging)

### -----------
### combined
###

data <- zori %>%
  left_join(hud_data, by = c("RegionName" = "ZIP", "year" = "year")) %>%
  rename(hud_avg = br_avg, zori_avg = rent_avg)

# TODO: KableExtra table with quick summary stats of data object
```

### Census Socio-Economic Data

To place the housing market data into better context we combined it with socio-economic data provided by the US Census Bureau's American Community Survey. ZIP code-level data is provided only in their 5 year estimate data products, which limited our ability to thoroughly analyze changes over 1 year time periods. To accommodate this limitation we pulled the data for two non-overlapping 5 year estimates, 2014 and 2019, and used them to supplement our findings.

```{r}
# Defines acs5_pull function, lists the variables used, and calculates values with those variables
source(here("ingest_census_data.R"))

zips <- data %>%
  pull(RegionName) %>%
  unique()

acs_2014 <- acs5_pull(2014, zips) %>%
  # Including zips in the function call is supposed to prevent us needing
  # to filter by zip, but it's not working.
  mutate(ZIP = str_extract(NAME, "[0-9]{5}?")) %>%
  filter(ZIP %in% zips)

acs_2019 <- acs5_pull(2019, zips) %>%
  mutate(ZIP = str_extract(NAME, "[0-9]{5}?")) %>%
  filter(ZIP %in% zips)

data_2014 <- data %>%
  filter(year == 2014) %>%
  left_join(acs_2014, by = c("RegionName" = "ZIP", "year"))

data_2019 <- data %>%
  filter(year == 2019) %>%
  left_join(acs_2019, by = c("RegionName" = "ZIP", "year"))

# TODO: KableExtra table with basic summary statistics for data_2019
```

### Spatial Data

There may be a spatial component that would be necessary to understand the dynamics present within our data. To explore this we used the `tigris` package to acquire spatial data that would allow us to map the research data to real space. Spatial data was then joined to our research data for the purpose of visualizing the changes in the data over time in a way that allows a layperson to digest geographic differences. Because of Chicago's history of racial segregation leading to extreme spatial inequality, this research project serves as a testing ground to see if socio-economic differences play a part in the dynamics between observed rents and federal housing subsidies.

```{r }
### -----------------------------
### Spatial Data
### 

# Transforming to this CRS makes the map look "normal"
crs <- 3435 # coordinate reference system: IL NAD83 East

# Get Cook County geometry to put zctas in context
cook_county <- counties(state = "IL", cb = T, progress_bar = F) %>%
  filter(NAME == "Cook") %>% # Chicago + suburbs are almost entirely within Cook County
  select(NAME, geometry) %>%
  st_transform(crs)

# Create filter for ZIP geom pull
starts_with <- data %>% 
  pull(RegionName) %>% # Vectorize the column
  str_extract(pattern = "[0-9]{2}") %>%
  unique() # c("53", "60") 

### Get ZCTA geometry
zcta <- zctas(cb = T, starts_with = starts_with, progress_bar = F) %>%
  select(GEOID10, geometry) %>%
  st_transform(crs) %>%  # Without this transformation to ILNAD83 the map looks weird
  st_filter(cook_county) # There are ZIP codes that fall outside of Cook county
                         # that make the map less easy to digest. This removes them
```

## Analysis

### Macro-Level Trends

The following plot shows the aggregate trend lines of observed rents and FMR values. Observed rents increased over time, which is to be expected due to growth. FMR values typically lag behind observed rents, which is why the two trend lines are parallel. This is due to the fact that HUD FMR values are calculated using rent estimates from ACS 5 year gross rent estimates from two years prior to the year of valuation, omitting new construction from the observed rental housing stock. The shortening of the gap between the two values in 2018 was due to a [change in methodology](https://www.huduser.gov/portal/datasets/fmr/fmr2018/FY2018-FMR-Preamble.pdf) by HUD. In 2018, the FMR calculation stopped using 50th percentile FMR values and began using 40th percentile FMR values. While describing the impacts and outcomes of this change is not within the scope of this project, it is worth noting that this likely increased the mobility of households receiving federal housing subsidies. 

```{r }
### -----------
### Trend plot
###

data %>%
  group_by(year) %>%
  summarize(ZORI = mean(zori_avg, na.rm = T),
            HUD = mean(hud_avg, na.rm = T)) %>%
  pivot_longer(cols = c(ZORI:HUD),
               names_to = "index",
               values_to = "rent") %>%
  ggplot(aes(x = year, y = rent, color = index)) +
  geom_line(size = 2, lineend = "round") +
  labs(title = "Average Values, Fair Market Rent and Observed Rents, 2014 - 2020",
       subtitle = "HUD Fair Market Rent Average and Zillow Observed Rent Index Average",
       x = "Year",
       y = "Rent (in USD)",
       color = "Values") +
  theme_minimal() +
  scale_y_continuous(labels = scales::label_dollar())
```

These general trends in Chicago's rental housing market demonstrate that, on average, rent is increasing in the city. Housing subsidies follow similar trends, but never match those of observed rents. This indicates that households with the most need, those that receive rental subsidies, are chronically unable to afford high-quality housing in Chicago.

### Pulling Out the Magnifying Glass

The general trends described above provide insight into Chicago as a whole, opening up questions about whether these trends are experienced equally across Chicago ZIP codes. The following animation looks at the difference between observed rent and FMR values over time for ZIP codes where data was available. Please note that because of the way the difference was calculated it is not immediately apparent whether changes are due to a shift in HUD data, Zillow data, or both. 

```{r }
### -----------------------------
### Year-over-Year difference map
### Animation

map_anim <- data %>%
  # NOTE: Because of the way this is calculated we don't 
  # have any indication if the change is due to a change in 
  # ZORI or HUD values
  mutate(diff = zori_avg - hud_avg) %>% 
  left_join(zcta, by = c("RegionName" = "GEOID10")) %>%
  ggplot(aes(geometry = geometry)) +
  geom_sf(data = cook_county) + # County boundary
  geom_sf(aes(fill = diff)) + # ZCTA map
  labs(title = "Year: {current_frame}", # Adds the year value to the title through interpolation
       caption = "In some ZIP codes, the difference between ZORI and HUD FMR has changed drastically",
       fill = "ZORI - HUD") + 
  scale_fill_viridis_c() +
  theme_minimal() +
  transition_manual(year) # transition_time doesn't work well with sf for some reason

animate(map_anim, fps = 1, nframes = 6)
```

The following distribution plots help us understand that this is an effect of HUD FMR increasing, not ZORI decreasing. What does this mean for housing affordability? This could mean that HUD voucher recipients are being provided a wider range of places to move to as HUD FMR begins to match average rents.

```{r}
### --------------
### ZIP/Rent distribution plot
###

dist_anim <- data %>% 
  group_by(RegionName, year) %>%
  summarize(ZORI = mean(zori_avg, na.rm = T),
         HUD = mean(hud_avg, na.rm = T)) %>%
  ggplot() +
  geom_density(aes(x = ZORI), fill = "blue", alpha = .5) +
  geom_density(aes(x = HUD), fill = "red", alpha = .5) +
  labs(title = "Distribution of Rent Values by ZIP Code, {current_frame}",
       subtitle = "blue is ZORI, red is HUD",
       x = "Rent", 
       y = "Density") +
  transition_manual(year)

animate(dist_anim, fps = 1, nframes = 6)
```
We see that the HUD FMR is starting to match the market rate closer and closer but we see the centers of both distributions are slowing rightward and simultaneously the distribution shape is getting wider and flatter. What could explain this change in variation and simultaneous shifting in rent over time? 

### Socio-Economic Characteristic Context

To add some context to this issue we will combine our rent index data with income data and look at the trend in income changes over time as compared to rent. To further isolate effects from income, we disaggregate by zip code to account for potential time constant effects associated with the zip code. The top 10 zip codes are selected by the difference in HUD versus Zillow market rates in 2014 and then compared with what they look like in 2019. Unfortunately we could use all the years present in our initial data set because the ACS data set from which we pull income data only has data for every 5 years.

```{r}
# TODO: make this into kable
data %>%
  mutate(diff = (zori_avg - hud_avg)/hud_avg) %>%
  ungroup() %>%
  filter(year == 2014) %>%
  arrange(desc(diff)) %>%
  slice(head(row_number(), 10)) %>%
  select(RegionName)
```

Here the income in relation to the market rent rates is represented by rent burden. Rent burden is based on HUD definition of housing affordability which is 30% of income. Any rent above 50% of income is conidered to be a high level of burden.
```{r fig.width=10, fig.height=11}
### ------------------
### Cleveland Dot Plot 
### include ACS data

neighborhoods <-
  list(
    "60045" = "Lake County",
    "60602" = "Downtown",
    "60610" = "Near Northside, Cabrini Green",
    "60126" = "Elmhurst",
    "60642" = "River West",
    "60647" = "Logan Square",
    "60616" = "Chinatown, Armour Square, Bridgeport",
    "60525" = "La Grange",
    "60612" = "East Garfield Park",
    "60608" = "Pilsen"
  )

cleveland_data <-
  data %>%
  # can't do functions in label assignments so gotta do it here
  mutate(diff = (zori_avg - hud_avg)/hud_avg) %>%
  ungroup() %>%
  filter(RegionName %in% names(neighborhoods) & year %in% c(2014,2019)) %>%
  pivot_longer(cols = c(zori_avg:hud_avg),
               names_to = "source",
               values_to = "rent") %>%
  mutate(neighborhood = neighborhoods[RegionName])

acs_to_year_mapping <- list(
  "2014" = data_2014,
  "2019" = data_2019
)

# still figuring out the best aesthetic 
cleveland_plot <- function(input_data, yr, acs) {
  plot_data <-
    input_data %>%
    left_join(acs[[as.character(yr)]], by = c("RegionName", "year")) %>%
    filter(year == yr) %>%
    mutate(income_diff = rent/(median_hh_income/12),
           # based on HUD definition of housing affordability
           burden = cut(income_diff,
                        breaks=c(0, 0.3, 0.5, 1),
                        labels=c("Low","Medium","High")))
  
  ggplot(data = plot_data,
         mapping = aes(x = RegionName, y = rent)) +
    # line showing the difference between the HUD and Zillow indices
    geom_line(aes(group = RegionName, color = burden), size = 5) +
    # shapes representing either HUD or Zillow index
    geom_point(aes(shape = source), size = 5) +
    # labeling the difference by percentage between indices
    geom_text(
      data = plot_data %>% filter(source == "zori_avg"),
      mapping = aes(
                    label = paste0(
                      "+", scales::percent(x = diff,
                                           accuracy = 0.01)
                    )),
      size = 3.5,
      hjust = -0.25
    ) +
    # labeling the lines with the neighborhood
    geom_text(
      data = plot_data %>% filter(source == "hud_avg"),
      mapping = aes(label = neighborhood),
      size = 3.5,
      hjust = 0,
      nudge_x = 0.5
    ) +
    scale_y_continuous(labels = scales::dollar_format(),
                       limits = c(800, 3200)) +
    coord_flip() +
    labs(
      title = paste0("Zip Codes With Rent Furthest From Fair Market Rate, ", yr),
      subtitle = "HUD versus Zillow with Average Monthly Median Income",
      x = "ZIP",
      y = "Rent Index",
      shape = "Source",
      color = "Rent Burden"
    ) +
    scale_color_manual(values = c("#00ba38","#83b0fc","#F8766D")) +
    scale_shape_manual(values = c("circle","square"), labels = c("HUD", "Zillow"))
}

cleveland_plot(cleveland_data, 2014, acs_to_year_mapping) / cleveland_plot(cleveland_data, 2019, acs_to_year_mapping)
```

In comparing 2014 to 2019 we see that the neighborhoods typically known for gentrification show up in some of the largest differences in market rates. This is especially true in regards to neighborhoods that were historically marginalized. Adding in the income data we see that while incomes for areas like Downtown have increased over time, thereby reducing the rent burden, but the incomes in the marginalized areas have not proportionally increased.

```{r}
### -------------------
### coor plot
### diff and hh_income
# TODO: Do the same with gini_index, percent_snap_recipients, and percent_black_pop

plot1 <- data_2014 %>%
  mutate(diff = zori_avg - hud_avg) %>%
  ggplot(aes(x = median_hh_income, y = diff)) +
  geom_jitter() +
  geom_smooth(method = "lm") +
  labs(title = "Observed Minus Fair Market Rent Compared with Household Income, 2014",
      x = "Median Household Income",
      y = "ZORI - FMR Values (in USD)") +
  scale_x_continuous(limits = c(0, 190000))

plot2 <- data_2019 %>%
  mutate(diff = zori_avg - hud_avg) %>%
  ggplot(aes(x = median_hh_income, y = diff)) +
  geom_jitter() +
  geom_smooth(method = "lm") +
  labs(title = "Observed Minus Fair Market Rent Compared with Household Income, 2019",
      x = "Median Household Income",
      y = "ZORI - FMR Values (in USD)") +
  scale_x_continuous(limits = c(0, 190000))

plot1 / plot2
```

# Conclusions

## Limitations

Differences between ZORI and FMR data, missing ZORI values for some months could effect the generalizability of rents for some years.

Dollar values aren't inflation adjusted, which would be important for a more in-depth analysis. However, since \$1000 in 2014 is equivalent to \$1118.87 today we can ignore it without running into any major methodological issues.

### Missingness in data

```{r fig.width=12, fig.height=6}
# TODO: Visualize missingness in zori data. This could use zori_raw or zori_staging I think. Whichver works best. Have to figure out to label the year lines.

vis_miss(zori_raw %>% select(c("2014-01":"2021-02"))) + 
  geom_vline(xintercept = seq(from = 0, to = 94, by = 12), size = 1) +
  # geom_text(aes(x=seq(from = 0, to = 94, by = 12), label="test", y=0), colour="#00ba38", angle=0, text=element_text(size=11)) +
  theme(axis.text.x = element_text(angle = 90))
```
We see here that missing data is much more of a concern for the first couple years, 2014 and 2015, especially in the upper range of rents, but less of an issue for the later years. This missing data seems to be Missing at Random, or MAR, since there doesn't seem to be any specific mechanism linking the missingness of rental data to those particular periods.

After the join between HUD and Zillow data, we find that Zillow has data on some years that HUD doesn't, but it is not enough cause concern:
```{r fig.width=10, fig.height=5}
vis_miss(data %>% select(zori_avg, hud_avg)) +
  ggplot(data %>% 
           group_by(year) %>%
           summarise(n_missing = sum(is.na(hud_avg)))) +
  geom_bar(aes(x = year, y = n_missing), stat="identity") + 
  # TODO: show every year on x axis
  scale_y_continuous(limits = c(0,5))
```


## Findings

HUD FMR jumped significantly from 2017 to 2018. We should look into why that happened. 

### Policy Implications

### Further Questions